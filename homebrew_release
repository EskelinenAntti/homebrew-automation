#!/bin/bash

set -e
FORMULA=$1

if [[ $# -ne 1 ]]
then
  echo "Usage "$0" FORMULA"
  exit 0
fi

# New release and tag
gh release create --fail-on-no-commits --generate-notes

# Tarball url
URL="$(gh repo view --json url | jq -r .url)/archive/refs/tags/$(gh release view --json tagName | jq -r .tagName).tar.gz"

REPO=$(gh repo view --json nameWithOwner --jq ".nameWithOwner")
SHA256=$(curl -Ls "$URL" | shasum -a 256 | awk '{ print $1 }')

brew bump-formula-pr "$FORMULA" --url "$URL" --sha256 $SHA256 --no-fork
